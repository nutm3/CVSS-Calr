document.addEventListener('DOMContentLoaded', () => {

    const vectorDisplay = document.getElementById('vector-string');
    const scoreCircle = document.getElementById('score-circle');
    const severityText = document.getElementById('severity-text');
    const inputs = document.querySelectorAll('input[type="radio"]');
    const copyBtn = document.getElementById('btn-copy');
    const copyFeedback = document.querySelector('.copy-feedback');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');

    const reportBtn = document.getElementById('btn-report');
    const reportModal = document.getElementById('report-modal');
    const closeModal = document.getElementById('close-modal');
    const reportPreviewBody = document.getElementById('report-preview-body');
    const downloadReportBtn = document.getElementById('btn-download-report');

    let currentVector = "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:N";
    let currentScore = "0.0";
    let currentSeverity = "NONE";

    function getVectorString() {
        const metrics = ['AV', 'AC', 'PR', 'UI', 'S', 'C', 'I', 'A'];
        let vec = "CVSS:3.1";
        metrics.forEach(m => {
            const val = document.querySelector(`input[name="${m}"]:checked`).value;
            vec += `/${m}:${val}`;
        });
        return vec;
    }

    async function updateScore() {
        const vector = getVectorString();
        currentVector = vector;
        vectorDisplay.textContent = vector;

        try {
            const res = await fetch('/api/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vector })
            });
            const data = await res.json();

            if (data.score !== undefined) {
                currentScore = data.score;
                currentSeverity = data.severity;
                scoreCircle.textContent = data.score;
                severityText.textContent = data.severity;
                scoreCircle.className = `score-circle sev-${data.severity}`;
            }
        } catch (err) {
            console.error(err);
        }
    }

    function setVector(vectorStr) {
        const parts = vectorStr.split('/');
        parts.forEach(p => {
            const [key, val] = p.split(':');
            if (key && val && key !== 'CVSS') {
                const radio = document.querySelector(`input[name="${key}"][value="${val}"]`);
                if (radio) radio.checked = true;
            }
        });
        updateScore();
    }

    function generateReportText() {
        const date = new Date().toLocaleString();
        let report = `=================================================\n`;
        report += `       CVSSCalr v1.0 - VULNERABILITY REPORT\n`;
        report += `=================================================\n`;
        report += `[+] PRIMARY ASSESSMENT\n`;
        report += `-------------------------------------------------\n`;
        report += `Date            : ${date}\n`;
        report += `Generated By    : CVSSCalr v1.0\n`;
        report += `[+] RISK PROFILE\n`;
        report += `-------------------------------------------------\n`;
        report += `Base Score      : ${currentScore} \n`;
        report += `Severity        : ${currentSeverity.toUpperCase()}\n`;
        report += `Vector String   : ${currentVector}\n`;
        report += `[+] VULNERABILITY METRICS\n`;
        report += `-------------------------------------------------\n`;

        const m = (key) => {
            const radio = document.querySelector(`input[name="${key}"]:checked`);
            const label = radio ? radio.closest('.radio-option').querySelector('.option-label').innerText.trim() : "None";
            return `${label} (${radio ? radio.value : 'N'})`;
        };

        report += `Exploitability Metrics:\n`;
        report += `- Attack Vector (AV)        : ${m('AV')}\n`;
        report += `- Attack Complexity (AC)    : ${m('AC')}\n`;
        report += `- Privileges Required (PR)  : ${m('PR')}\n`;
        report += `- User Interaction (UI)     : ${m('UI')}\n`;
        report += `Impact Metrics:\n`;
        report += `- Scope (S)                 : ${m('S')}\n`;
        report += `- Confidentiality Impact (C): ${m('C')}\n`;
        report += `- Integrity Impact (I)      : ${m('I')}\n`;
        report += `- Availability Impact (A)   : ${m('A')}\n`;

        report += `[+] ANALYSIS SUMMARY & IMPLICATIONS\n`;
        report += `-------------------------------------------------\n`;
        let summary = "";
        const score = parseFloat(currentScore);
        if (score >= 9.0) {
            summary = "Kerentanan ini bersifat KRITIS dan dapat dieksploitasi dengan dampak maksimal. Penyerang dapat memperoleh kontrol penuh atas sistem secara remote, yang berarti kompromi total terhadap kerahasiaan, integritas, dan ketersediaan data sangat mungkin terjadi.";
        } else if (score >= 7.0) {
            summary = "Kerentanan TINGGI yang memungkinkan penyerang menyebabkan kerusakan signifikan atau pencurian data sensitif. Diperlukan tindakan segera untuk memitigasi risiko sebelum dieksploitasi oleh pihak tidak bertanggung jawab.";
        } else if (score >= 4.0) {
            summary = "Kerentanan TINGKAT SEDANG yang memerlukan kondisi khusus atau interaksi untuk eksploitasi. Meskipun risiko tidak segera melumpuhkan sistem, perbaikan tetap disarankan untuk memperkuat postur keamanan.";
        } else {
            summary = "Kerentanan TINGKAT RENDAH dengan dampak minimal. Biasanya berupa kebocoran informasi non-sensitif atau memerlukan kompleksitas serangan yang sangat tinggi.";
        }
        report += summary + "\n";

        report += `[+] REMEDIATION PRIORITY\n`;
        report += `-------------------------------------------------\n`;
        let priority = "P3 (Routine Action)";
        if (score >= 4.0) priority = "P2 (Scheduled Fix)";
        if (score >= 7.0) priority = "P1 (Urgent Action)";
        if (score >= 9.0) priority = "P0 (Immediate Action Required)";

        report += `Priority Level  : ${priority}\n`;
        report += `Status          : ${currentSeverity} Discovery\n`;
        report += `=================================================\n`;
        report += `Generated by CVSSCalr - Advanced Severity Engine\n`;
        report += `-------------------------------------------------\n`;
        return report;
    }

    function generateHTML() {
        const date = new Date().toLocaleString();
        const m = (key) => {
            const radio = document.querySelector(`input[name="${key}"]:checked`);
            const label = radio ? radio.closest('.radio-option').querySelector('.option-label').innerText.trim() : "None";
            return `${label} (${radio ? radio.value : 'N'})`;
        };

        const score = parseFloat(currentScore);
        let summary = "";
        if (score >= 9.0) {
            summary = "Kerentanan ini bersifat KRITIS dan dapat dieksploitasi dengan dampak maksimal. Penyerang dapat memperoleh kontrol penuh atas sistem secara remote, yang berarti kompromi total terhadap kerahasiaan, integritas, dan ketersediaan data sangat mungkin terjadi.";
        } else if (score >= 7.0) {
            summary = "Kerentanan TINGGI yang memungkinkan penyerang menyebabkan kerusakan signifikan atau pencurian data sensitif. Diperlukan tindakan segera untuk memitigasi risiko sebelum dieksploitasi oleh pihak tidak bertanggung jawab.";
        } else if (score >= 4.0) {
            summary = "Kerentanan TINGKAT SEDANG yang memerlukan kondisi khusus atau interaksi untuk eksploitasi. Meskipun risiko tidak segera melumpuhkan sistem, perbaikan tetap disarankan untuk memperkuat postur keamanan.";
        } else {
            summary = "Kerentanan TINGKAT RENDAH dengan dampak minimal. Biasanya berupa kebocoran informasi non-sensitif atau memerlukan kompleksitas serangan yang sangat tinggi.";
        }

        let priority = "P3 (Routine Action)";
        if (score >= 4.0) priority = "P2 (Scheduled Fix)";
        if (score >= 7.0) priority = "P1 (Urgent Action)";
        if (score >= 9.0) priority = "P0 (Immediate Action Required)";

        const sevClass = currentSeverity.toLowerCase();

        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Executive Report - ${currentSeverity}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #000; background: #fff; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; border: 1px solid #ddd; padding: 40px; border-radius: 8px; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { margin: 0; color: #000; font-size: 26px; text-transform: uppercase; letter-spacing: 2px; }
        .section-title { background: #f4f4f4; padding: 12px; font-weight: bold; border-left: 6px solid #333; margin: 30px 0 15px 0; color: #000; font-size: 1.1rem; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000; }
        table td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
        .badge { display: inline-block; padding: 6px 16px; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }
        .sev-critical { background: #000; color: #fff; border: 2px solid #ff0000; }
        .sev-high { background: #ff4d4d; color: #fff; }
        .sev-medium { background: #ffa500; color: #000; }
        .sev-low { background: #50fa7b; color: #000; }
        .sev-none { background: #eee; color: #000; }
        .footer { text-align: center; margin-top: 50px; font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 20px; }
        .metric-group { font-weight: bold; color: #444; margin-top: 10px; display: block; border-bottom: 1px dashed #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VULNERABILITY ASSESSMENT REPORT</h1>
            <p style="margin:5px 0 0 0; color:#444;">CVSSCalr v1.0 - Advanced Security Engine</p>
        </div>
        
        <div class="section-title">[+] PRIMARY ASSESSMENT</div>
        <table>
            <tr><td width="35%">Date</td><td>${date}</td></tr>
            <tr><td>Generated By</td><td>CVSSCalr v1.0</td></tr>
        </table>

        <div class="section-title">[+] RISK PROFILE</div>
        <table>
            <tr><td width="35%">Base Score</td><td><span style="font-size: 1.8rem; font-weight: bold;">${currentScore}</span></td></tr>
            <tr><td>Severity</td><td><span class="badge sev-${sevClass}">${currentSeverity}</span></td></tr>
            <tr><td>Vector String</td><td><code>${currentVector}</code></td></tr>
        </table>

        <div class="section-title">[+] VULNERABILITY METRICS</div>
        <span class="metric-group">Exploitability Metrics</span>
        <table>
            <tr><td width="45%">Attack Vector (AV)</td><td>${m('AV')}</td></tr>
            <tr><td>Attack Complexity (AC)</td><td>${m('AC')}</td></tr>
            <tr><td>Privileges Required (PR)</td><td>${m('PR')}</td></tr>
            <tr><td>User Interaction (UI)</td><td>${m('UI')}</td></tr>
        </table>
        <span class="metric-group">Impact Metrics</span>
        <table>
            <tr><td width="45%">Scope (S)</td><td>${m('S')}</td></tr>
            <tr><td>Confidentiality Impact (C)</td><td>${m('C')}</td></tr>
            <tr><td>Integrity Impact (I)</td><td>${m('I')}</td></tr>
            <tr><td>Availability Impact (A)</td><td>${m('A')}</td></tr>
        </table>

        <div class="section-title">[+] ANALYSIS SUMMARY & IMPLICATIONS</div>
        <p style="padding: 0 10px;">${summary}</p>

        <div class="section-title">[+] REMEDIATION PRIORITY</div>
        <table>
            <tr><td width="35%">Priority Level</td><td><strong>${priority}</strong></td></tr>
            <tr><td>Status</td><td>${currentSeverity} Discovery</td></tr>
        </table>
        
        <div class="footer">
            Generated by CVSSCalr Engine | Security Compliance Audit
        </div>
    </div>
</body>
</html>`;
    }

    function printReport() {
        const html = generateHTML();
        const printWin = window.open('', '_blank');
        printWin.document.write(html);
        printWin.document.close();
        // Wait a bit for assets if any, then print
        setTimeout(() => {
            printWin.print();
            printWin.onafterprint = () => printWin.close();
        }, 500);
    }

    function getSummaryText(score) {
        if (score >= 9.0) return "Kerentanan ini bersifat KRITIS dan dapat dieksploitasi dengan dampak maksimal. Penyerang dapat memperoleh kontrol penuh atas sistem secara remote, yang berarti kompromi total terhadap kerahasiaan, integritas, dan ketersediaan data sangat mungkin terjadi.";
        if (score >= 7.0) return "Kerentanan TINGGI yang memungkinkan penyerang menyebabkan kerusakan signifikan atau pencurian data sensitif. Diperlukan tindakan segera untuk memitigasi risiko sebelum dieksploitasi oleh pihak tidak bertanggung jawab.";
        if (score >= 4.0) return "Kerentanan TINGKAT SEDANG yang memerlukan kondisi khusus atau interaksi untuk eksploitasi. Meskipun risiko tidak segera melumpuhkan sistem, perbaikan tetap disarankan untuk memperkuat postur keamanan.";
        return "Kerentanan TINGKAT RENDAH dengan dampak minimal. Biasanya berupa kebocoran informasi non-sensitif atau memerlukan kompleksitas serangan yang sangat tinggi.";
    }

    function getPriorityText(score) {
        if (score >= 9.0) return "P0 (Immediate Action Required)";
        if (score >= 7.0) return "P1 (Urgent Action)";
        if (score >= 4.0) return "P2 (Scheduled Fix)";
        return "P3 (Routine Action)";
    }

    function generateCSV() {
        const scoreValue = parseFloat(currentScore);
        let csv = "Section,Metric,Value\n";
        csv += `PRIMARY,Date,"${new Date().toLocaleString()}"\n`;
        csv += `PRIMARY,Generated By,CVSSCalr v1.0\n`;
        csv += `RISK,Base Score,${currentScore}\n`;
        csv += `RISK,Severity,${currentSeverity}\n`;
        csv += `RISK,Vector,${currentVector}\n`;

        const metrics = getDetailedMetrics();
        Object.keys(metrics).forEach(m => {
            csv += `METRIC,${m},"${metrics[m].label} (${metrics[m].value})"\n`;
        });

        csv += `ANALYSIS,Summary,"${getSummaryText(scoreValue)}"\n`;
        csv += `PRIORITY,Level,"${getPriorityText(scoreValue)}"\n`;
        csv += `PRIORITY,Status,"${currentSeverity} Discovery"\n`;
        return csv;
    }

    function generateJSON() {
        const scoreValue = parseFloat(currentScore);
        return JSON.stringify({
            report_type: "VULNERABILITY REPORT",
            metadata: { app: "CVSSCalr v1.0", date: new Date().toISOString() },
            assessment: {
                score: scoreValue,
                severity: currentSeverity,
                vector: currentVector
            },
            metrics: getDetailedMetrics(),
            analysis: {
                summary: getSummaryText(scoreValue),
                priority_level: getPriorityText(scoreValue),
                status: `${currentSeverity} Discovery`
            }
        }, null, 4);
    }

    function generateYAML() {
        const scoreValue = parseFloat(currentScore);
        const metrics = getDetailedMetrics();
        let yaml = `report_type: "VULNERABILITY REPORT"\n`;
        yaml += `metadata:\n  app: "CVSSCalr v1.0"\n  date: "${new Date().toISOString()}"\n`;
        yaml += `assessment:\n  score: ${scoreValue}\n  severity: "${currentSeverity}"\n  vector: "${currentVector}"\n`;
        yaml += `metrics:\n`;
        Object.keys(metrics).forEach(m => {
            yaml += `  ${m}: "${metrics[m].label} (${metrics[m].value})"\n`;
        });
        yaml += `analysis:\n  summary: "${getSummaryText(scoreValue)}"\n`;
        yaml += `  priority_level: "${getPriorityText(scoreValue)}"\n`;
        yaml += `  status: "${currentSeverity} Discovery"\n`;
        return yaml;
    }

    function getDetailedMetrics() {
        const results = {};
        ['AV', 'AC', 'PR', 'UI', 'S', 'C', 'I', 'A'].forEach(m => {
            const radio = document.querySelector(`input[name="${m}"]:checked`);
            if (radio) {
                const optionLabel = radio.closest('.radio-option').querySelector('.option-label').innerText.trim();
                results[m] = { label: optionLabel, value: radio.value };
            }
        });
        return results;
    }

    inputs.forEach(input => {
        input.addEventListener('change', updateScore);
    });

    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(currentVector).then(() => {
            copyFeedback.style.display = 'inline';
            setTimeout(() => { copyFeedback.style.display = 'none'; }, 2000);
        });
    });

    reportBtn.addEventListener('click', () => {
        reportPreviewBody.textContent = generateReportText();
        reportModal.style.display = 'flex';
    });

    closeModal.addEventListener('click', () => { reportModal.style.display = 'none'; });
    window.addEventListener('click', (e) => { if (e.target === reportModal) reportModal.style.display = 'none'; });

    document.getElementById('btn-print-report').addEventListener('click', printReport);

    downloadReportBtn.addEventListener('click', () => {
        const format = document.getElementById('report-format').value;
        let content = "", contentType = "text/plain", extension = "txt";

        switch (format) {
            case 'csv': content = generateCSV(); contentType = "text/csv"; extension = "csv"; break;
            case 'json': content = generateJSON(); contentType = "application/json"; extension = "json"; break;
            case 'yaml': content = generateYAML(); contentType = "text/yaml"; extension = "yaml"; break;
            case 'html': content = generateHTML(); contentType = "text/html"; extension = "html"; break;
            case 'md': content = generateReportText(); contentType = "text/markdown"; extension = "md"; break;
            default: content = generateReportText(); extension = "txt"; break;
        }

        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CVSS_Report_${new Date().getTime()}.${extension}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        reportModal.style.display = 'none';
    });

    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    async function handleFile(file) {
        dropZone.textContent = "‚è≥ Analyzing Writeup...";

        const formData = new FormData();
        formData.append('writeup', file);

        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.vector) {
                setVector(data.vector);
                dropZone.textContent = `‚úÖ Analysis Complete! Vector: ${data.vector}`;
                setTimeout(() => {
                    dropZone.textContent = "üìÇ HEURISTIC ANALYSIS: Drag & Drop 'readme.md' (Writeup) here";
                }, 5000);
            } else {
                dropZone.textContent = "‚ùå Analysis Failed.";
            }
        } catch (err) {
            console.error(err);
            dropZone.textContent = "‚ùå Error uploading file.";
        }
    }

    updateScore();
});
